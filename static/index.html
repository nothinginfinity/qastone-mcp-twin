<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA.Stone Demo</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { text-align: center; color: #888; margin-bottom: 30px; }

        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 { margin-bottom: 15px; color: #4ade80; font-size: 1.2em; }

        .login-section { text-align: center; }
        .token-input {
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #4ade80;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            width: 300px;
            margin-right: 10px;
        }
        .btn {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: #4ade80; color: #000; }
        .btn-primary:hover { background: #22c55e; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; margin: 5px; }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }

        .demo-tokens {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .wallet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .stone-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #4ade80;
        }
        .stone-card.gift_card { border-left-color: #ffd700; }
        .stone-card.api_token { border-left-color: #3b82f6; }
        .stone-card.coupon { border-left-color: #10b981; }
        .stone-icon { font-size: 2em; margin-bottom: 10px; }
        .stone-sponsor { font-weight: bold; }
        .stone-value { color: #4ade80; font-size: 1.2em; }
        .stone-id { font-size: 0.7em; color: #666; word-break: break-all; }

        .transfer-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .transfer-form select, .transfer-form input {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 14px;
        }

        .inbox-item {
            background: rgba(74, 222, 128, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            text-align: center;
        }
        .stat-item { padding: 15px; }
        .stat-value { font-size: 2em; color: #4ade80; }
        .stat-label { color: #888; font-size: 0.9em; }

        .status { padding: 5px 10px; border-radius: 20px; font-size: 0.8em; }
        .status.online { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .status.offline { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        .server-status {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }
        .server-badge {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hidden { display: none; }
        .message {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .message.success { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .message.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        .users-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        .user-card {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .user-avatar { font-size: 2em; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíé QA.Stone Demo</h1>
        <p class="subtitle">MCP Twin Server with Hot-Swap Capability</p>

        <!-- Server Status -->
        <div class="server-status">
            <div class="server-badge">
                <span class="status" id="status-a">‚óè</span>
                <span>Twin A</span>
            </div>
            <div class="server-badge">
                <span class="status" id="status-b">‚óè</span>
                <span>Twin B</span>
            </div>
        </div>

        <!-- Login Section -->
        <div class="card login-section" id="login-section">
            <h2>üîê Enter Your Demo Token</h2>
            <div>
                <input type="text" class="token-input" id="token-input" placeholder="demo_alice_2026">
                <button class="btn btn-primary" onclick="login()">Login</button>
            </div>
            <div class="demo-tokens">
                <span style="color:#888">Quick login:</span>
                <button class="btn btn-secondary" onclick="quickLogin('alice')">Alice</button>
                <button class="btn btn-secondary" onclick="quickLogin('bob')">Bob</button>
                <button class="btn btn-secondary" onclick="quickLogin('charlie')">Charlie</button>
                <button class="btn btn-secondary" onclick="quickLogin('diana')">Diana</button>
                <button class="btn btn-secondary" onclick="quickLogin('eve')">Eve</button>
            </div>
        </div>

        <!-- Main App (hidden until login) -->
        <div id="main-app" class="hidden">
            <div id="message-area"></div>

            <!-- User Info -->
            <div class="card">
                <h2>üë§ Welcome, <span id="username">User</span>!</h2>
                <button class="btn btn-secondary" onclick="logout()" style="float:right;margin-top:-35px;">Logout</button>
            </div>

            <!-- Wallet -->
            <div class="card">
                <h2>üí∞ Your Wallet (<span id="wallet-count">0</span> stones, <span id="wallet-value">$0</span>)</h2>
                <div class="wallet-grid" id="wallet-grid"></div>
            </div>

            <!-- Send Stone -->
            <div class="card">
                <h2>üì§ Send a Stone</h2>
                <div class="transfer-form">
                    <select id="stone-select"></select>
                    <span>‚Üí</span>
                    <select id="recipient-select"></select>
                    <button class="btn btn-primary" onclick="sendStone()">Send</button>
                </div>
            </div>

            <!-- Inbox -->
            <div class="card">
                <h2>üì• Inbox (<span id="inbox-count">0</span> pending)</h2>
                <div id="inbox-list"></div>
            </div>

            <!-- All Users -->
            <div class="card">
                <h2>üë• All Users</h2>
                <div class="users-list" id="users-list"></div>
            </div>

            <!-- System Stats -->
            <div class="card">
                <h2>üìä System Stats</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="stat-users">0</div>
                        <div class="stat-label">Users</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-stones">0</div>
                        <div class="stat-label">Stones</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-value">$0</div>
                        <div class="stat-label">Total Value</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-pending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_A = 'https://qastone-mcp-twin-production.up.railway.app';
        const API_B = 'https://qa-stone-b-production.up.railway.app';
        const WS_A = 'wss://qastone-mcp-twin-production.up.railway.app';
        const WS_B = 'wss://qa-stone-b-production.up.railway.app';
        let currentAPI = API_A;
        let currentWS = WS_A;
        let currentToken = null;
        let currentUsername = null;
        let websocket = null;

        // Check server status
        async function checkServers() {
            try {
                const resA = await fetch(`${API_A}/health`);
                const dataA = await resA.json();
                document.getElementById('status-a').className = 'status ' + (dataA.status === 'healthy' ? 'online' : 'offline');
                document.getElementById('status-a').textContent = dataA.status === 'healthy' ? '‚óè Online' : '‚óè Offline';
            } catch {
                document.getElementById('status-a').className = 'status offline';
                document.getElementById('status-a').textContent = '‚óè Offline';
            }

            try {
                const resB = await fetch(`${API_B}/health`);
                const dataB = await resB.json();
                document.getElementById('status-b').className = 'status ' + (dataB.status === 'healthy' ? 'online' : 'offline');
                document.getElementById('status-b').textContent = dataB.status === 'healthy' ? '‚óè Online' : '‚óè Offline';
            } catch {
                document.getElementById('status-b').className = 'status offline';
                document.getElementById('status-b').textContent = '‚óè Offline';
            }
        }

        function showMessage(text, type = 'success') {
            const area = document.getElementById('message-area');
            area.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => area.innerHTML = '', 3000);
        }

        function quickLogin(name) {
            document.getElementById('token-input').value = `demo_${name}_2026`;
            login();
        }

        async function login() {
            const token = document.getElementById('token-input').value.trim();
            if (!token) return;

            currentToken = token;
            currentUsername = token.replace('demo_', '').replace('_2026', '');

            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('username').textContent = currentUsername.charAt(0).toUpperCase() + currentUsername.slice(1);

            // Connect WebSocket for real-time notifications
            connectWebSocket();

            await refreshAll();
        }

        function logout() {
            // Disconnect WebSocket
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            currentToken = null;
            currentUsername = null;
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function connectWebSocket() {
            if (websocket) websocket.close();

            const wsUrl = `${currentWS}/ws/${currentToken}`;
            websocket = new WebSocket(wsUrl);

            websocket.onopen = () => {
                console.log('WebSocket connected');
                showMessage('Real-time notifications enabled', 'success');
            };

            websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            websocket.onclose = () => {
                console.log('WebSocket disconnected');
                // Reconnect after 3 seconds if still logged in
                if (currentToken) {
                    setTimeout(connectWebSocket, 3000);
                }
            };

            websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            // Send ping every 25 seconds to keep alive
            setInterval(() => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({ type: 'ping' }));
                }
            }, 25000);
        }

        function handleWebSocketMessage(data) {
            console.log('WS message:', data);

            switch (data.type) {
                case 'connected':
                    console.log(`Connected to ${data.server_instance}`);
                    break;

                case 'transfer_received':
                    showMessage(`üì• ${data.message}`, 'success');
                    // Auto-refresh inbox
                    loadInbox();
                    // Play notification sound (optional)
                    playNotificationSound();
                    break;

                case 'transfer_sent':
                    showMessage(`üì§ ${data.message}`, 'success');
                    // Auto-refresh wallet
                    loadWallet();
                    break;

                case 'server_event':
                    showMessage(`üîî ${data.message}`, 'success');
                    break;

                case 'hot_swap':
                    showMessage(`üîÑ Server swap: ${data.message}`, 'success');
                    break;

                case 'heartbeat':
                    // Silent heartbeat
                    break;
            }
        }

        function playNotificationSound() {
            // Simple beep using Web Audio API
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = ctx.createOscillator();
                const gain = ctx.createGain();
                oscillator.connect(gain);
                gain.connect(ctx.destination);
                oscillator.frequency.value = 800;
                gain.gain.value = 0.1;
                oscillator.start();
                setTimeout(() => oscillator.stop(), 150);
            } catch (e) {}
        }

        async function refreshAll() {
            await Promise.all([
                loadWallet(),
                loadInbox(),
                loadUsers(),
                loadStats()
            ]);
        }

        async function loadWallet() {
            const res = await fetch(`${currentAPI}/api/users/${currentUsername}/wallet`);
            const data = await res.json();

            document.getElementById('wallet-count').textContent = data.summary.stone_count;
            document.getElementById('wallet-value').textContent = data.summary.total_value_usd;

            const grid = document.getElementById('wallet-grid');
            const select = document.getElementById('stone-select');

            grid.innerHTML = data.items.map(stone => `
                <div class="stone-card ${stone.type}">
                    <div class="stone-icon">${getIcon(stone.type)}</div>
                    <div class="stone-sponsor">${stone.sponsor}</div>
                    <div class="stone-value">${stone.value}</div>
                    <div class="stone-id">${stone.stone_id}</div>
                </div>
            `).join('') || '<p style="color:#888">No stones yet</p>';

            select.innerHTML = data.items.map(stone =>
                `<option value="${stone.stone_id}">${stone.sponsor} (${stone.value})</option>`
            ).join('') || '<option>No stones</option>';
        }

        async function loadInbox() {
            const res = await fetch(`${currentAPI}/api/inbox/${currentToken}`);
            const data = await res.json();

            document.getElementById('inbox-count').textContent = data.pending_count;

            const list = document.getElementById('inbox-list');
            list.innerHTML = data.transfers.map(t => `
                <div class="inbox-item">
                    <div>
                        <strong>${t.sponsor}</strong> ${t.value} from ${t.from.replace('user_', '')}
                    </div>
                    <button class="btn btn-primary" onclick="acceptTransfer('${t.transfer_id}')">Accept</button>
                </div>
            `).join('') || '<p style="color:#888">No pending transfers</p>';
        }

        async function loadUsers() {
            const res = await fetch(`${currentAPI}/api/users`);
            const data = await res.json();

            const list = document.getElementById('users-list');
            const select = document.getElementById('recipient-select');

            list.innerHTML = data.users.map(u => `
                <div class="user-card">
                    <div class="user-avatar">üë§</div>
                    <div><strong>${u.username}</strong></div>
                    <div style="color:#888">${u.stone_count} stones</div>
                    <div style="color:#4ade80">${u.total_value_usd}</div>
                </div>
            `).join('');

            select.innerHTML = data.users
                .filter(u => u.username !== currentUsername)
                .map(u => `<option value="${u.username}">${u.username}</option>`)
                .join('');
        }

        async function loadStats() {
            const res = await fetch(`${currentAPI}/api/stats`);
            const data = await res.json();

            document.getElementById('stat-users').textContent = data.stats.users;
            document.getElementById('stat-stones').textContent = data.stats.stones;
            document.getElementById('stat-value').textContent = data.stats.total_value_usd;
            document.getElementById('stat-pending').textContent = data.stats.pending_transfers;
        }

        async function sendStone() {
            const stoneId = document.getElementById('stone-select').value;
            const recipient = document.getElementById('recipient-select').value;

            if (!stoneId || !recipient) return;

            // Use /api/transfer/notify for real-time WebSocket notifications
            const res = await fetch(`${currentAPI}/api/transfer/notify?from_token=${currentToken}&to_username=${recipient}&stone_id=${stoneId}`, {
                method: 'POST'
            });
            const data = await res.json();

            if (data.success) {
                // WebSocket will handle the notification, but refresh anyway
                await refreshAll();
            } else {
                showMessage(data.error || 'Failed to send', 'error');
            }
        }

        async function acceptTransfer(transferId) {
            const res = await fetch(`${currentAPI}/api/accept?token=${currentToken}&transfer_id=${transferId}`, {
                method: 'POST'
            });
            const data = await res.json();

            if (data.success) {
                showMessage('Transfer accepted!');
                await refreshAll();
            } else {
                showMessage(data.error || 'Failed to accept', 'error');
            }
        }

        function getIcon(type) {
            const icons = {
                gift_card: 'üéÅ',
                api_token: 'üîë',
                coupon: 'üè∑Ô∏è',
                event_ticket: 'üéüÔ∏è'
            };
            return icons[type] || 'üì¶';
        }

        // Init
        checkServers();
        setInterval(checkServers, 30000);
    </script>
</body>
</html>
